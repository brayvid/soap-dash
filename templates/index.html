{# templates/index.html (Multi-tab dashboard) #}
{% extends "base.html" %}

{% block content %}
    
    <nav class="dashboard-tabs" style="margin-bottom: 20px; text-align: center;">
        <a href="{{ url_for('dashboard', tab='approval') }}" 
           class="tab-link {% if active_tab == 'approval' %}active{% endif %}">Approval</a>
        <a href="{{ url_for('dashboard', tab='trends') }}" 
           class="tab-link {% if active_tab == 'trends' %}active{% endif %}">Trends</a>
        <a href="{{ url_for('dashboard', tab='similarity') }}" 
           class="tab-link {% if active_tab == 'similarity' %}active{% endif %}">Similarity</a>
        <a href="{{ url_for('dashboard', tab='dataset') }}"
           class="tab-link {% if active_tab == 'dataset' %}active{% endif %}">Dataset</a> {# New Tab Link #}
    </nav>
    <hr style="margin-bottom: 20px;">

    {# --- APPROVAL RATINGS TAB CONTENT --- #}
    {% if active_tab == 'approval' %} 
        <section id="approval-ratings-content">
            <h2>All Approval Ratings</h2>
            <p>Shows 'Approve', 'Neutral', 'Disapprove' votes based on word sentiment. Politicians with fewer than selected minimum scorable votes excluded.</p>
                
            <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
                <input type="hidden" name="tab" value="approval">
                
                <div class="slider-container form-group" style="margin-bottom: 1rem;">
                    <div>
                        <label for="min_votes_slider_approval" class="form-label" style="margin-right: 5px; display: inline;">Minimum submissions:</label>
                        <span id="slider_value_approval" class="slider-current-value" style="font-weight: bold;">{{ approval_data.min_votes_current }}</span>
                    </div>
                    
                    <input type="range" class="form-range-slider" id="min_votes_slider_approval" name="min_votes" 
                        min="1" max="100" value="{{ approval_data.min_votes_current }}" step="1" 
                        oninput="updateSliderValue('min_votes_slider_approval', 'slider_value_approval')"
                        onchange="this.form.submit()">
                </div>
            </form>

            {% if approval_data.dist_img_base64 %}
                <div class="plot-container" style="text-align: center; margin: 1.5rem 0;">
                    <img src="data:image/png;base64,{{ approval_data.dist_img_base64 }}" alt="Approval Distribution Chart" style="max-width: 100%; height: auto;">
                </div>
            {% elif approval_data.min_votes_current %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">No politicians meet threshold of {{ approval_data.min_votes_current }} scorable votes for distribution.</div>
            {% else %}
                 <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">Adjust the slider to view data.</div>
            {% endif %}

            <details class="data-expander">
                <summary>View Approval Rating Data</summary>
                {% if approval_data.df_sentiment_dist is not none and not approval_data.df_sentiment_dist.empty %}
                    <div class="table-scroll-wrapper">
                        {{ approval_data.df_sentiment_dist[['politician_name', 'approve_percent', 'neutral_percent', 'disapprove_percent', 'total_votes']].to_html(classes='styled-table data-table', index=False, formatters={'approve_percent': '{:.1f}%'.format, 'neutral_percent': '{:.1f}%'.format, 'disapprove_percent': '{:.1f}%'.format}) | safe }}
                    </div>
                {% else %}
                    <p class="text-muted">No data to display.</p>
                {% endif %}
            </details>
        </section>

    {# --- WEEKLY TRENDS TAB CONTENT --- #}
    {% elif active_tab == 'trends' %}
        <section id="weekly-trends-content">
            <h2>Weekly Trends & Comparison</h2>
            
            <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
                <input type="hidden" name="tab" value="trends">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="politician_multiselector_trends" class="form-label">Select Politicians:</label>
                    <p><small><input type="checkbox" name="politician_select_mode_trends" value="All" {% if 'All' in request.args.get('politician_select_mode_trends', '') %}checked{% endif %} onchange="this.form.submit()"> Select All Available</small></p>
                    <select multiple class="form-multiselect" id="politician_multiselector_trends" name="politician_ids_trends" size="8">
                        {% if trends_data.all_politicians is not none and not trends_data.all_politicians.empty %}
                            {% for pol in trends_data.all_politicians.to_dict(orient='records') %}
                                <option value="{{ pol.politician_id }}" {% if pol.politician_id in trends_data.selected_politician_ids %}selected{% endif %}>
                                    {{ pol.name }}
                                </option>
                            {% endfor %}
                        {% else %}
                            <option disabled>Politician list unavailable.</option>
                        {% endif %}
                    </select>
                    <small class="form-text-hint">Hold Ctrl/Cmd to select multiple.</small>
                </div>
                <button type="submit" class="button-primary">Update Trend Chart</button>
            </form>

            {% if trends_data.selected_politician_names %}
                <h3 style="margin-top: 1.5rem;">
                {% if trends_data.selected_politician_names|length == 1 %}Trend for: {{ trends_data.selected_politician_names[0] }}
                {% else %}Trend Comparison for {{ trends_data.selected_politician_names|length }} politicians
                {% endif %}
                </h3>
            {% endif %}

            {% if trends_data.weekly_trend_img_base64 %}
                <div class="plot-container" style="text-align: center; margin: 1.5rem 0;">
                    <img src="data:image/png;base64,{{ trends_data.weekly_trend_img_base64 }}" alt="Weekly Trend Chart" style="max-width: 100%; height: auto;">
                </div>
            {% elif trends_data.selected_politician_ids %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">No weekly approval rating data for the selected politician(s).</div>
            {% elif trends_data.all_politicians is not none and not trends_data.all_politicians.empty %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">ℹ️ Select politician(s) above.</div>
            {% else %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">Waiting for data...</div>
            {% endif %}

            <details class="data-expander">
                <summary>View Weekly Trend Data</summary>
                {% if trends_data.df_display_ready is not none and not trends_data.df_display_ready.empty %}
                    <div class="table-scroll-wrapper">
                        {{ trends_data.df_display_ready.to_html(classes='styled-table data-table', index=False, formatters={'weekly_approval_rating_percent': '{:.0f}%'.format, 'week_start_date': '{:%Y-%m-%d}'.format}) | safe }}
                    </div>
                {% else %}
                    <p class="text-muted">No data to display.</p>
                {% endif %}
            </details>
        </section>
    {# --- SIMILARITY TAB CONTENT --- #}
    {% elif active_tab == 'similarity' %}
        <section id="valence-similarity-content">
            <h2>Sentiment Similarity Matrix</h2>
            <p>Heatmap shows similarity based on sentiment profiles. Score closer to 1 indicates more similar profiles.</p>

        <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
                <input type="hidden" name="tab" value="similarity">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="politician_multiselector_similarity" class="form-label">Select Politicians (Max {{ similarity_data.MAX_HEATMAP_POLITICIANS }} shown):</label>
                    <p><small><input type="checkbox" name="politician_select_mode_similarity" value="All" {% if 'All' in request.args.get('politician_select_mode_similarity', '') %}checked{% endif %} onchange="this.form.submit()"> Select All Available</small></p>
                    
                    <select multiple class="form-multiselect" id="politician_multiselector_similarity" name="politician_ids_similarity" size="10">
                        {% if similarity_data.available_politicians %}
                            {% for pol in similarity_data.available_politicians %}
                                <option value="{{ pol.politician_id }}" {% if pol.politician_id in similarity_data.selected_politician_ids %}selected{% endif %}>
                                    {{ pol.politician_name }} (Votes: {{ pol.total_votes }})
                                </option>
                            {% endfor %}
                        {% else %}
                            <option disabled>No politicians found.</option>
                        {% endif %}
                    </select>
                    <small class="form-text-hint">Hold Ctrl/Cmd to select multiple.</small>
                </div>
                <button type="submit" class="button-primary">Generate Heatmap</button>
            </form>

            {% if similarity_data.heatmap_img_base64 %}
                <div class="plot-container" style="text-align: center; margin: 1.5rem 0;">
                    <img src="data:image/png;base64,{{ similarity_data.heatmap_img_base64 }}" alt="Valence Similarity Heatmap" style="max-width: 100%; height: auto;">
                </div>
            {% elif similarity_data.selected_politician_ids and similarity_data.df_for_similarity_calc is not none and similarity_data.df_for_similarity_calc|length <= 1 %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">Need at least two politicians for similarity analysis.</div>
            {% elif similarity_data.available_politicians %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">ℹ️ Select politician(s) above.</div>
            {% else %}
                <div class="info-message" style="background-color: #eef; padding: 10px; border-radius: 5px;">No politicians available.</div>
            {% endif %}
            
            {% if similarity_data.df_for_similarity_calc is not none and not similarity_data.df_for_similarity_calc.empty and similarity_data.df_for_similarity_calc|length > similarity_data.MAX_HEATMAP_POLITICIANS %}
                <div class="warning-message" style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px;">Displaying heatmap for top {{ similarity_data.MAX_HEATMAP_POLITICIANS }} politicians.</div>
            {% endif %}

            <details class="data-expander">
                <summary>View Similarity Matrix Data</summary>
                {% if similarity_data.similarity_df_html %}
                    <div class="table-scroll-wrapper">
                        {{ similarity_data.similarity_df_html | safe }}
                    </div>
                {% elif similarity_data.selected_politician_ids %}
                    <p class="text-muted">Not enough data or politicians to generate matrix.</p>
                {% else %}
                    <p class="text-muted">No data to display.</p>
                {% endif %}
            </details>
        </section>
    {# --- DATASET METRICS TAB CONTENT --- #}
    {% elif active_tab == 'dataset' %}
        <section id="dataset-metrics-content">
            <h2>Dataset Metrics</h2>
            <p>Basic statistics about the underlying dataset.</p>
            
            {% if dataset_data and dataset_data.metrics %}
                <div class="metrics-container" style="background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin-left: auto; margin-right: auto;">
                    <ul style="list-style-type: none; padding-left: 0;">
                        <li style="margin-bottom: 12px; font-size: 1.1em; padding: 8px; border-bottom: 1px solid #eee;">
                            <strong>Politicians:</strong> <span style="float: right; font-weight: bold; color: #337ab7;">{{ dataset_data.metrics.total_politicians }}</span>
                        </li>
                        <li style="margin-bottom: 12px; font-size: 1.1em; padding: 8px; border-bottom: 1px solid #eee;">
                            <strong>Unique Words:</strong> <span style="float: right; font-weight: bold; color: #337ab7;">{{ dataset_data.metrics.total_words_scorable }}</span>
                        </li>
                        <li style="margin-bottom: 12px; font-size: 1.1em; padding: 8px; border-bottom: 1px solid #eee;">
                            <strong>Submissions:</strong> <span style="float: right; font-weight: bold; color: #337ab7;">{{ dataset_data.metrics.total_votes }}</span>
                        </li>
                        <li style="font-size: 1.1em; padding: 8px;">
                            <strong>Date Range:</strong> <span style="float: right; font-weight: bold; color: #337ab7;">{{ dataset_data.metrics.votes_date_range }}</span>
                        </li>
                    </ul>
                </div>
            {% elif not engine_available %}
                <p class="text-muted">Database connection not available. Cannot retrieve dataset metrics.</p>
            {% else %}
                <p class="text-muted">Could not retrieve dataset metrics at this time.</p>
            {% endif %}
        </section>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
function updateSliderValue(sliderId, outputId) {
    const slider = document.getElementById(sliderId);
    const output = document.getElementById(outputId);
    if (slider && output) {
        output.innerHTML = slider.value;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    if ("{{ active_tab }}" === "approval") {
        const slider = document.getElementById('min_votes_slider_approval');
        const output = document.getElementById('slider_value_approval');
        if (slider && output) {
            output.innerHTML = slider.value; 
        }
    }
});
</script>
{% endblock %}